<!DOCTYPE html>
<html>
<head>
<title>Framebuffer</title>
<script type="text/javascript">
const Cc = Components.classes;
const Ci = Components.interfaces;
const Cu = Components.utils;

function init() {
  Cu.import(document.location + 'adb.jsm');
  var img = document.getElementById('img');

  var convert5to8 = [];
  for (var i = 0; i < Math.pow(2, 5); i++)
    convert5to8[i] = (i * 527 + 23) >> 6;
  var convert6to8 = [];
  for (var i = 0; i < Math.pow(2, 6); i++)
    convert6to8[i] = (i * 259 + 33) >> 6;

  function mulTableFor(width) {
    if (width == 5)
      return convert5to8;
    if (width == 6)
      return convert6to8;
    throw 'Unsupported';
  }

  var encoder = Cc["@mozilla.org/image/encoder;2?type=image/png"].createInstance();
  encoder.QueryInterface(Ci.imgIEncoder);

  ADB.devices(function (devices) {
    var matching = [d for each (d in devices) if (d.serial.toLowerCase() == document.location.host)];
    if (matching.length > 1)
      throw 'Ambiguous serial';
    ADB.getFrameBuffer(matching[0].serial, function (image) {
      if (image.depth == 32 &&
          image.redOffset == 0 && image.redWidth == 8 &&
          image.greenOffset == 8 && image.greenWidth == 8 &&
          image.blueOffset == 16 && image.blueWidth == 8 &&
          image.alphaOffset == 24 && image.alphaWidth == 8) {
        var data = new Array(image.size);
        for (var i = 0; i < image.size; i++) { data[i] = image.data.charCodeAt(i);}
        encoder.initFromData(data, image.width * image.height * 4, image.width, image.height, image.width * 4, Ci.imgIEncoder.INPUT_FORMAT_RGBA, '');
      } else if (image.depth == 16 && image.alphaWidth == 0) {
        var redShift = image.redOffset;
        var greenShift = image.greenOffset;
        var blueShift = image.blueOffset;
        var redMask = (Math.pow(2, image.redWidth) - 1) << redShift;
        var greenMask = (Math.pow(2, image.greenWidth) - 1) << greenShift;
        var blueMask = (Math.pow(2, image.blueWidth) - 1) << blueShift;
        var redMul = mulTableFor(image.redWidth);
        var greenMul = mulTableFor(image.greenWidth);
        var blueMul = mulTableFor(image.blueWidth);
        var data = new Array(image.width * image.height * 3);
        for (var i = 0; i < image.size / 2; i++) {
          var pixel = image.data.charCodeAt(i * 2) + (image.data.charCodeAt(i * 2 + 1) << 8);
          data[i * 3] = redMul[(pixel & redMask) >> redShift];
          data[i * 3 + 1] = greenMul[(pixel & greenMask) >> greenShift];
          data[i * 3 + 2] = blueMul[(pixel & blueMask) >> blueShift];
        }
        encoder.initFromData(data, image.width * image.height * 3, image.width, image.height, image.width * 3, Ci.imgIEncoder.INPUT_FORMAT_RGB, '');
      }
      var rawStream = encoder.QueryInterface(Ci.nsIInputStream);
      var stream = Cc["@mozilla.org/binaryinputstream;1"].createInstance();
      stream.QueryInterface(Ci.nsIBinaryInputStream);
      stream.setInputStream(rawStream);
      var bytes = stream.readByteArray(stream.available());
      img.src = 'data:image/png;base64,' + toBase64(bytes);
    });
  });
}

/* toBase64 copied from image/test/unit/test_encoder_png.js */

/* Convert data (an array of integers) to a Base64 string. */
const toBase64Table = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz' +
    '0123456789+/';
const base64Pad = '=';
function toBase64(data) {
    var result = '';
    var length = data.length;
    var i;
    // Convert every three bytes to 4 ascii characters.
    for (i = 0; i < (length - 2); i += 3) {
        result += toBase64Table[data[i] >> 2];
        result += toBase64Table[((data[i] & 0x03) << 4) + (data[i+1] >> 4)];
        result += toBase64Table[((data[i+1] & 0x0f) << 2) + (data[i+2] >> 6)];
        result += toBase64Table[data[i+2] & 0x3f];
    }

    // Convert the remaining 1 or 2 bytes, pad out to 4 characters.
    if (length%3) {
        i = length - (length%3);
        result += toBase64Table[data[i] >> 2];
        if ((length%3) == 2) {
            result += toBase64Table[((data[i] & 0x03) << 4) + (data[i+1] >> 4)];
            result += toBase64Table[(data[i+1] & 0x0f) << 2];
            result += base64Pad;
        } else {
            result += toBase64Table[(data[i] & 0x03) << 4];
            result += base64Pad + base64Pad;
        }
    }

    return result;
}

window.addEventListener("load", init, false);
</script>
</head>
<body>
<img id='img'>
</body>
</html>
